<html lang="en">
  <head>
    <title>SVG to STL conversion</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="js/external/jquery-3.4.1.min.js"></script>
    <!-- WebGL Geometry and rendering library -->
    <script src="js/external/three.js"></script>
    <script src="js/external/FaceNormalsHelper.js"></script>
    <script src="js/external/OrbitControls.js"></script>
    <!-- Turn an SVG path into a three.js geometry -->
    <script src="js/external/d3-threeD.js"></script>
    <!-- Write a three.js geometry into ASCII STL -->
    <script src="js/external/STLExporter.js"></script>
    <!-- "Flatten" an SVG document by applying all transforms to the paths -->
    <script src="js/external/flatten.js"></script>
    <!-- Constructive Solid Geometry -->
    <script src="js/external/ThreeCSG.js"></script>
    <!-- In-memory file reads and writes -->
    <script src="js/external/FileSaver.js"></script>
    <!-- Code that pulls all of the above together -->
    <script src="js/SVGtoSTL.js"></script>
    
    <!-- Color picker -->
    <script src="js/external/bootstrap-colorpicker.min.js"></script>
    <link rel="stylesheet" href="css/external/bootstrap-colorpicker.min.css">
    
    <!-- use bootstap for display -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" 
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- dark colors -->
    <link rel="stylesheet" href="css/external/bootstrap-dark.min.css">
  </head>
  <body>
    <div class="container-xl" id="main-container">
     <h1>SVG to STL conversion</h1>
     <p class="lead">This tool has been developped within <a href="https://activmap.limos.fr/">ACTIVmap project</a> to convert 2D images into meshes for 3D printing. 
     The main goal is to provide an easy-to-use way to generate 3D maps for people with visual impairment.</p>
     <div class="row">
        <div class="col-md-6 col-lg-4">
            <h2>Input SVG image</h2>
            <form>
                <div class="btn btn-primary btn-block" style="position: relative">
                        <label style="padding: 0; margin: 0">Choose file</label>
                        <input type="file" id="svgInputFile" name="files[]" accept="image/svg+xml" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; opacity: 0">
                    </div>
            </form>
            <div class="card">
                <img src="img/image.svg" class="card-img-top" alt="svg image (not yet selected)" id="uploadedSVG">
                <div class="card-body">
                    <h5 class="card-title"  id="svgTitle"></h5>
                    <p class="card-text" id="svgText"></p>
                </div>
            </div>

        </div>
        <div class="col-md-6 col-lg-8">
            <h2>Options</h2>
            <form>
                <ul class="nav nav-tabs" id="optionTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" role="tab" href="#shape-options" id="shape-options-tab" aria-controls="shape-options-tab" aria-selected="true">Shapes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" role="tab" href="#display-options" id="display-options-tab" aria-controls="display-options-tab" aria-selected="false">Display</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" role="tab" href="#advanced-options" id="advanced-options-tab" aria-controls="advanced-options-tab" aria-selected="false">Advanced</a>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane show active my-sm-3" id="shape-options" role="tabpanel" aria-labelledby="shape-options-tab">
                        <fieldset>
                            <h3>Shapes</h3>
                            
                            <div class="form-group">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Original color</th>
                                            <th scope="col">Elevation from the base in the 3D object</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableDepths">
                                        <tr>
                                            <th scope="row" style="vertical-align: middle">1</th>
                                            <td style="vertical-align: middle"><span style="background: #000000; cursor: auto" class="btn">#000000</span></td>
                                            <td><input type="number" class="form-control" id="typeDepth1" value="3"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <small class="form-text text-muted">Unit: millimeters. Only positive values.</small>
                            </div>
                            
                        </fieldset>
                    </div>
                    <div class="tab-pane my-sm-3" id="display-options" role="tabpanel" aria-labelledby="display-options-tab">
                        <h3>Geometry</h3>
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="showWireFrame">
                                <label class="form-check-label" for="showWireFrame">
                                    Show Wire Frame
                                </label>
                        </div>
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="showEdges" checked>
                                <label class="form-check-label" for="showEdges">
                                    Show Edges
                                </label>
                        </div>
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="showNormals">
                                <label class="form-check-label" for="showNormals">
                                    Show Normals
                                </label>
                        </div>
                        <h3>Colors</h3>
                        <div class="form-check">
                                <label class="form-check-label" for="colorPicker">
                                    Rendering color
                                </label>
                            <input class="form-control" id="colorPicker" type="text" value="#007bff" />
                        </div>

                    </div>
                    <div class="tab-pane my-sm-3" id="advanced-options" role="tabpanel" aria-labelledby="advanced-options-tab">
                                                <h3>Size</h3>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="ignoreSVGSize">
                                <label class="form-check-label" for="ignoreSVGSize">
                                    Force image size (ignoring SVG value)
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-check-label" for="objectWidth">
                                    Object width
                                </label>
                                <input type="number" step="1" min="1" pattern="\d+" class="form-control" id="objectWidth" aria-describedby="objectWidthHelper" value="60" disabled="disabled">
                                <small id="objectWidthHelper" class="form-text text-muted">Unit: millimeters. Only positive values.</small>
                            </div>
                            

                        <h3>Base</h3>
                        
                        <div class="form-row">
                                <div class="form-group col">

                                        <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="Use Base Plate" id="wantBasePlate" checked>
                                                <label class="form-check-label" for="wantBasePlate">
                                                    Use Base Plate
                                                </label>
                                        </div>
                                        <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="Ignore document margins" id="ignoreDocumentMargins">
                                                <label class="form-check-label" for="ignoreDocumentMargins">
                                                    Ignore document margins (given size is type size)
                                                </label>
                                        </div>                   
                                </div>
                                <div class="form-group col">

                                    <label class="title baseShape" for="basePlateShape">Base Plate Shape</label>
                                    
                                    <select class="custom-select" id="basePlateShape">
                                        <option selected value="Rectangular">Rectangular</option>
                                        <option value="Circular">Circular</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col">
                                    <label for="baseDepth">Depth of base</label>
                                    <input type="number" step="1" min="1" pattern="\d+" class="form-control" id="baseDepth" aria-describedby="baseDepthHelper" value="5">
                                    <small id="baseDepthHelper" class="form-text text-muted">Unit: millimeters. Only positive values.</small>
                                </div>
                                <div class="form-group col">
                                    <label for="buffer">Buffer</label>
                                    <input type="number" step="1" min="0" pattern="\d+" class="form-control" id="buffer" aria-describedby="bufferHelper" value="0">
                                    <small id="bufferHelper" class="form-text text-muted">Unit: millimeters. Only positive values.</small>
                                </div>
                            </div>
                        <h3>Fine SVG reading</h3>
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Invert Type" id="invertType">
                                <label class="form-check-label" for="invertType">
                                    Invert Type
                                </label>
                        </div>
                        
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Reverse Winding Order" id="reverseWO">
                                <label class="form-check-label" for="reverseWO">
                                    Reverse Winding Order
                                </label>
                        </div>
                    </div>
                </div>

                <input type="submit" class="btn btn-primary btn-block" id="renderButton" disabled="disabled" value="Re-render" />
            </form>
        </div>
    </div>
    <div class="row my-sm-3">
        <div class="col">
            <h2>Output 3D object</h2>
            <div class="card mb-3">
                <div id="stlCanvas" class="stlCanvas card-img-top"></div>
                <div class="card-body">
                    <h5 class="card-title">Generated mesh</h5>
                    <p class="card-text" id="meshText"></p>
                    <form>
                        <button type="submit" class="btn btn-primary btn-block" id="download" disabled="disabled">Download mesh</button>
                    </form>
                </div>        
            </div>
        </div>
    </div>
    <div class="footer-page font-small mb-3" style="font-size: 80%">
	    <a href="https://github.com/jmtrivial/svg-to-stl">SVG-to-STL</a> by <a href="https://jmfavreau.info">Jean-Marie Favreau</a> for <a href="https://activmap.limos.fr">ACTIVmap project</a>, March 2020. Special thanks to Ryan Calme for the <a href="https://github.com/rcalme/svg-to-stl">first version of this tool</a>, and for developers of the libraries used in this software.</footer>
    </div>
    
  <!-- In-memory file read and parsing -->
  <script>
    $(document).ready( function () {
        // loading a svg file will run the rendering process
        $("#svgInputFile").on("change", handleFileSelect);
    
        // enable value selection
        $('#ignoreSVGSize').on('change', function() {
            $('#objectWidth').prop('disabled', !$('#ignoreSVGSize').is(":checked"));
        });

    
        // Initialize the color picker
        $("#colorPicker").colorpicker();
        //$("#colorPicker").spectrum({ color: "#5d9dea" });
        // Handler for form submit
        $("#renderButton").click(function(e){
            e.preventDefault();
            // Numeric validations would go here
            clearGroup(group);
            // regenerate mesh
            var geom = renderObject(svgPaths, viewBox, svgColors, scene, group, camera, getFormSelections());
            // give info to the user about the mesh
            displayInfos(geom);

            return true;
        });   
        // Disable some options that don't apply when base plate is off
        $("input#wantBasePlate").change(function() {
            $("#ignoreSVGSize").prop( "disabled", !this.checked );
            $("input[name=baseShape]").prop( "disabled", !this.checked );
            $("label.baseShape").toggleClass("disabled");
            $("input#baseDepth").prop( "disabled", !this.checked );
            $("label.baseDepth").toggleClass("disabled");
            $("input#buffer").prop( "disabled", !this.checked );
            $("label.buffer").toggleClass("disabled");
            $("select#basePlateShape").prop( "disabled", !this.checked );
        });
        // When asked to export 3D scene to STL file, do so,
        // using the uploaded filename with a changed extension
        $("#download").on("click", function(){ saveSTL(scene, fileName.replace(/\.[^\.]*$/, "")); });
    });

    
    // given geometric information computed from a mesh
    // write it to the final user
    function displayInfos(geom) {
        $("#meshText").html("This mesh contains " + geom.vertices + " vertices and " + geom.faces + " faces. <br />Its bounding box is ["
                        + geom.bbox.min.x.toFixed(2) + ", " + geom.bbox.min.y.toFixed(2) + ", " + geom.bbox.min.z.toFixed(2) + "] [" 
                        + geom.bbox.max.x.toFixed(2) + ", " + geom.bbox.max.y.toFixed(2) + ", " + geom.bbox.max.z.toFixed(2) + "].");
    }
    
    // Check for webgl support
    function webgl() {
        try {
            var canvas = document.createElement( 'canvas' ); return !! ( window.WebGLRenderingContext && ( canvas.getContext( 'webgl' ) || canvas.getContext( 'experimental-webgl' ) ) );
        } catch ( e ) {
            return false;
        }
    }

    // Check for FileReader API support
    function fileapi() {
        return window.File && window.FileReader && window.FileList && window.Blob;
    }

    // Message to be built if webgl/fileapi support isn't present
    function notSupportedMessage(element) {
        $(element).empty();    // Clear the element
        $(element).append($("<div class='container'><div class='notsupported'></div></div>"));
        $(".notsupported").append($("<p class='big'>NOPE.</p>"));
        $(".notsupported").append($("<p class='small'>Your browser doesn't seem to support WebGL and/or the FileReader API.</p>"));
        $(".notsupported").append($("<p class='small'>Try a recent browser like <a href='https://www.google.com/chrome/browser/desktop' target='_blank'>Chrome</a> or <a href='https://www.mozilla.org/en-US/firefox' target='_blank'>Firefox</a>.</p>"));
    }

    // First check if support is present for the functions we'll use
    if(!webgl() || !fileapi()) {
        // Print a message that the browser doesn't support what we need
        notSupportedMessage($("body")); 
    }
            
    // Remember the file name of the uploaded SVG
    // we'll re-use this with a ".stl" extension at download time
    var fileName;
    // The 'path' tags from the SVG are all we need to keep.
    var svgPaths = [];
    // the colors associated to each of the path in the svg
    var svgColors = [];
    
    // SVG viewBox 
    var viewBox = [];

    // width (in mm, cm or in) contained in the svg header
    var svgwidth = null;

    var initialMaxDepth = 3;
    // a storage of the depths associated to colors.
    var colorDepths = {"#000000" : initialMaxDepth };
    
    // Pull options from the form
    function getFormSelections() {
        
        // update color depths
        for (i = 0; i < $("tbody#tableDepths tr").length; i++) {
            colorDepths[$("tbody#tableDepths tr#lineDepth" + i + " td span").html().toLowerCase()] = Number($("tbody#tableDepths tr#lineDepth" + i + " td input").val());
            
        }
        
        return {
            objectWidth: $("input#ignoreSVGSize").prop("checked") || svgwidth == null ? Math.abs(Number($("input#objectWidth").val())) : svgwidth,
            typeDepths: colorDepths,
            wantInvertedType: $("input#invertType").prop("checked"),
            svgWindingIsCW: $("input#reverseWO").prop("checked"),
            wantBasePlate: $("input#wantBasePlate").prop("checked"),
            basePlateShape: $("select#basePlateShape option:selected").val(),
            baseDepth: Math.abs(Number($("input#baseDepth").val())),
            baseBuffer: Math.abs(Number($("input#buffer").val())),
            wantWireFrame: $("input#showWireFrame").prop("checked"),
            wantEdges: $("input#showEdges").prop("checked"),
            wantNormals: $("input#showNormals").prop("checked"),
            objectColor: $("input#colorPicker").val(),
            squareBase: $("input#squareBase").prop("checked"),
            ignoreDocumentMargins: $("input#ignoreDocumentMargins").prop("checked")
        };
    }
    
    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }


    
    function getSVGColor(color) {
        color = color.toLowerCase();
        if (color in colorDepths) {
            return colorDepths[color];
        }
        else {
            rgb = hexToRgb(color);
            val = (3 - (rgb.r + rgb.g + rgb.b) / 256 / 3 * initialMaxDepth).toFixed(2);
            colorDepths[color] = val;
            return val;
        }
    }
    function setSVGColors(svgColors) {
        tableLines = "";
        
        list = svgColors.filter((x, i, a) => a.indexOf(x) == i).sort();
        
        for(i = 0; i < list.length; i++) {
            if (list[i] != "") {
                value = getSVGColor(list[i]);
                tableLines += "<tr id=\"lineDepth" + i + "\">" + 
                                "<th scope=\"row\" style=\"vertical-align: middle\">" + i + "</th>" +
                                "<td style=\"vertical-align: middle\"><span style=\"background: " + list[i] + "; cursor: auto" +
                                (value > 1.5 ? "; color: #ffffff" : "; color: #000000") +
                                "\" class=\"btn\">" + list[i] + "</span></td>" +
                                "<td><input type=\"number\" class=\"form-control\" id=\"typeDepth" + i + "\" value=\"" +
                                value + "\"></td>" +
                                "</tr>";
            }
        }
        $("#tableDepths").html(tableLines);

    }

    function handleFileSelect(evt) {
      // render button is active
      $('#renderButton').prop('disabled', false);
      $('#download').prop('disabled', false);

    
      var file = evt.target.files[0]; // FileList object

      
      // Only process image files.
      if (file.type!="image/svg+xml") {
        return;
      }

      // To parse the xml within the SVG file, render on-screen
      // and process it
      var readerString = new FileReader();



      // Closure to capture the file information.
      readerString.onload = (function(uploadedFile) {
        return function(e) {

          console.log("Parsing SVG paths...");
          // Get the paths out of the SVG
          var svgDoc = $.parseXML(e.target.result);

          // set on-screen
          doc = document.importNode(svgDoc.documentElement, true);
          doc.id = "uploadedSVG";
          
          sizeDefinition = "";

          // check if a width is given in mm, cm or in in the SVG file
          svgwidth = null;
          if ([6, 7, 8].includes(doc.width.baseVal.unitType)) {
            doc.width.baseVal.convertToSpecifiedUnits(7);
            svgwidth = doc.width.baseVal.valueInSpecifiedUnits;
            sizeDefinition += " Width: " + svgwidth + "mm.";
          }
          // check if a height is given in mm, cm or in in the SVG file
          svgheight = null;
          if ([6, 7, 8].includes(doc.height.baseVal.unitType)) {
            doc.height.baseVal.convertToSpecifiedUnits(7);
            svgheight = doc.height.baseVal.valueInSpecifiedUnits;
            sizeDefinition += " Height: " + svgheight + "mm.";
          }
          if (sizeDefinition == "")
            sizeDefinition = "No fabrication size defined in this file.";

          
          $('#uploadedSVG').replaceWith(doc);
          $('#uploadedSVG').addClass("card-img-top");
          $('#uploadedSVG').removeAttr("width");
          $('#uploadedSVG').removeAttr("height");
          $('#uploadedSVG').attr("alt", "svg image");
          $('#uploadedSVG').attr("id", "uploadedSVG");
          $('#uploadedSVG').addClass("card-img-top");
          
          // "Flatten" the SVG by applying all transforms to shapes and paths
          flatten(document.getElementById('uploadedSVG'));
          // Write to global paths variable. Is there an easy way to return from a closure?
          svgPaths = $("path", document.getElementById('uploadedSVG')).map(
                function(){return $(this).attr("d");}
          ).get();
          
          svgColors = $("path", document.getElementById('uploadedSVG')).map(
                function(){ 
                    var regex = /([\w-]*)\s*:\s*([^;]*)/g;
                    var match, properties={};
                    while(match=regex.exec($(this).attr("style"))) properties[match[1].trim()] = match[2].trim();
                    return "fill" in properties ? properties["fill"] : "#000000";
                }
          ).get();
          
          // set SVG colors in the UI and in the storage
          setSVGColors(svgColors);
          
          // get viewBox
          viewBox = [doc.viewBox.baseVal.x, doc.viewBox.baseVal.y,
                    doc.viewBox.baseVal.width, doc.viewBox.baseVal.height];

           // Store the file name in a global
          fileName = uploadedFile.name;

          // display information about the svg file
          $("#svgTitle").html(fileName);
          if (svgPaths.length == 0)
            $("#svgText").html("No path found in this image.<br />" + sizeDefinition);
          else if (svgPaths.length == 1)
            $("#svgText").html("One path found in this image.<br />" + sizeDefinition);
          else
            $("#svgText").html(svgPaths.length + " paths found in this image.<br />" + sizeDefinition);
          
          // In case this is the second file uploaded.
          clearGroup(group);
          
          // Render the SVG for the first time
          var geom = renderObject(svgPaths, viewBox, svgColors, scene, group, camera, getFormSelections());
          
          // give info to the user about the mesh
          displayInfos(geom);
        };
      })(file);

      // Read in the svg file (in-memory)
      console.log("Attempting to read file '"+file.name+"'...");

      // Reads the SVG contents into a string
      readerString.readAsText(evt.target.files[0]);
    };
  </script>

  <!-- Set up the 3D canvas, with rotation controls -->
  <script>
    var camera, scene, group, renderer, controls;
    if(webgl()) {
        init();
        $("#stlCanvas").append(renderer.domElement);
        animate();
    }

    function init() {
        var divWidth  = $("#main-container").width() - 2;
        var divHeight = divWidth * window.innerHeight / window.innerWidth;
        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setClearColor( 0x212529 );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( divWidth, divHeight );

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera( 50, divWidth/divHeight, 1, 1000 );
        camera.position.set( 0, -100, 100);

        controls = new THREE.OrbitControls( camera, renderer.domElement );
        controls.minDistance = 50;
        controls.maxDistance = 600;

        scene.add( new THREE.AmbientLight( 0x222222 ) );

        /// direct light
        var light = new THREE.DirectionalLight( 0x222222 );
        light.position.set( 0.75, 0.75, 1.0 ).normalize();
        scene.add( light );

        light = new THREE.PointLight( 0x222222 );
        light.position.copy( camera.position );
        scene.add( light );

        

        group= new THREE.Group();
        scene.add( group );

        /// backgroup grids
        var helper = new THREE.GridHelper( 70, 10 );
        helper.rotation.x = Math.PI / 2;
        group.add( helper );
        
        window.addEventListener( 'resize', onWindowResize, false );
        function onWindowResize(){
            var divWidth  = $("#main-container").width();
            var divHeight =  divWidth * 3 / 4;
            camera.aspect = divWidth / divHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( divWidth, divHeight );
        }
    }

    function animate() {
        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene, camera );
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>
